name: Create Release PR

on:
  # For making a release pr from android / ios sdk actions
  workflow_call:
    secrets:
      GH_PUSH_TOKEN:
        required: false
        description: "GitHub token for pushing changes"
    inputs:
      flutter_version:
        description: "New Flutter SDK Version (e.g., 5.3.4 or 5.3.4-beta.1)"
        required: true
        type: string
      android_version:
        description: "New Android SDK Version (e.g., 2.3.0). Leave blank to skip."
        required: false
        type: string
      ios_version:
        description: "New iOS SDK Version (e.g., 1.5.0). Leave blank to skip."
        required: false
        type: string
      target_branch:
        description: "Target branch to create the release PR on. Defaults to main."
        required: false
        type: string
        default: main

  # For making a release pr from the github actions
  workflow_dispatch:
    inputs:
      flutter_version:
        description: "New Flutter SDK Version (e.g., 5.2.15 or 5.2.15-beta.1)"
        required: true
        type: string
      android_version:
        description: "New Android SDK Version (e.g., 2.3.0). Leave blank to skip."
        required: false
        type: string
      ios_version:
        description: "New iOS SDK Version (e.g., 1.5.0). Leave blank to skip."
        required: false
        type: string
      target_branch:
        description: "Target branch to create the release PR on. Defaults to main."
        required: false
        type: string
        default: main

jobs:
  prep:
    uses: OneSignal/sdk-actions/.github/workflows/prep-release.yml@main
    secrets:
      # Need this cross-repo token (sdk-actions & this repo) to perform changes
      GH_PUSH_TOKEN: ${{ secrets.GH_PUSH_TOKEN }}
    with:
      # Need target_repo otherwise caller would set github.repository to the caller itself (e.g. sdk-actions)
      target_repo: OneSignal/OneSignal-Flutter-SDK
      version: ${{ inputs.flutter_version }}

  update_version:
    needs: prep
    runs-on: macos-latest
    outputs:
      flutter_from: ${{ steps.current_versions.outputs.flutter_from }}
      android_from: ${{ steps.current_versions.outputs.android_from }}
      ios_from: ${{ steps.current_versions.outputs.ios_from }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          # Need repository otherwise caller would set github.repository to the caller itself (e.g. sdk-actions)
          repository: OneSignal/OneSignal-Flutter-SDK
          ref: ${{ needs.prep.outputs.release_branch }}
          token: ${{ secrets.GH_PUSH_TOKEN || github.token }}

      - name: Get current native SDK versions
        id: current_versions
        run: |
          # Current flutter version
          CURRENT_VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | tr -d ' ')

          # Extract current Android SDK version
          ANDROID_VERSION=$(sed -n "s/.*com\.onesignal:OneSignal:\([^']*\)'.*/\1/p" android/build.gradle)

          # Extract current iOS SDK version
          IOS_VERSION=$(sed -n "s/.*OneSignalXCFramework', '\([^']*\)'.*/\1/p" ios/onesignal_flutter.podspec)

          echo "flutter_from=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "android_from=$ANDROID_VERSION" >> $GITHUB_OUTPUT
          echo "ios_from=$IOS_VERSION" >> $GITHUB_OUTPUT

      - name: Update Android SDK version
        if: inputs.android_version != ''
        run: |
          VERSION="${{ inputs.android_version }}"

          # Validate version exists on GitHub
          RELEASE=$(curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/OneSignal/OneSignal-Android-SDK/releases/tags/${VERSION}")


          if [ -z "$RELEASE" ]; then
            echo "✗ Android SDK version ${VERSION} not found"
            exit 1
          fi

          # Update build.gradle with new version
          # macOS sed syntax
          sed -i '' "s|implementation 'com\.onesignal:OneSignal:[^']*'|implementation 'com.onesignal:OneSignal:${VERSION}'|" android/build.gradle
          echo "✓ Updated android/build.gradle with Android SDK ${VERSION}"

          git add .

      - name: Update iOS SDK version
        if: inputs.ios_version != ''
        run: |
          VERSION="${{ inputs.ios_version }}"

          # Validate version exists on GitHub
          RELEASE=$(curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/OneSignal/OneSignal-iOS-SDK/releases/tags/${VERSION}")

          if [ -z "$RELEASE" ]; then
            echo "✗ iOS SDK version ${VERSION} not found"
            exit 1
          fi

          # Update onesignal_flutter.podspec with new version
          # macOS sed syntax
          sed -i '' "s|s.dependency 'OneSignalXCFramework', '[^']*'|s.dependency 'OneSignalXCFramework', '${VERSION}'|" ios/onesignal_flutter.podspec
          echo "✓ Updated ios/onesignal_flutter.podspec with iOS SDK ${VERSION}"

          # Update ios example
          cd example/ios
          pod update OneSignalXCFramework

          git add .

      - name: Update sdk version
        run: |
          NEW_VERSION="${{ inputs.flutter_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Convert version format for OneSignal wrapper (e.g., 5.2.15 -> 050215)
          # For pre-releases, extract base version first (e.g., 5.2.15-alpha.1 -> 5.2.15)
          BASE_VERSION=$(echo "$NEW_VERSION" | sed 's/-[a-z].*//')
          WRAPPER_VERSION=$(echo "$BASE_VERSION" | awk -F'.' '{printf "%02d%02d%02d", $1, $2, $3}')

          # Update pubspec.yaml version
          sed -i '' "s/^version:.*/version: $NEW_VERSION/" pubspec.yaml
          echo "✓ Updated pubspec.yaml version to ${NEW_VERSION}"

          # Update OneSignalPlugin.java wrapper version
          sed -i '' "s/OneSignalWrapper\.setSdkVersion(\"[^\"]*\")/OneSignalWrapper.setSdkVersion(\"$WRAPPER_VERSION\")/g" android/src/main/java/com/onesignal/flutter/OneSignalPlugin.java

          # Update OneSignalPlugin.m wrapper version
          sed -i '' "s/OneSignalWrapper\.sdkVersion = @\"[^\"]*\"/OneSignalWrapper.sdkVersion = @\"$WRAPPER_VERSION\"/g" ios/Classes/OneSignalPlugin.m

          git add .
          git commit -m "Release $NEW_VERSION"
          git push

  create-pr:
    needs: [prep, update_version]
    uses: OneSignal/sdk-actions/.github/workflows/create-release.yml@main
    secrets:
      # Need this cross-repo token (sdk-actions & this repo) to perform changes
      GH_PUSH_TOKEN: ${{ secrets.GH_PUSH_TOKEN }}
    with:
      # Need target_repo otherwise caller would set github.repository to the caller itself (e.g. sdk-actions)
      target_repo: OneSignal/OneSignal-Flutter-SDK
      release_branch: ${{ needs.prep.outputs.release_branch }}
      target_branch: ${{ inputs.target_branch }}
      android_from: ${{ needs.update_version.outputs.android_from }}
      android_to: ${{ inputs.android_version }}
      ios_from: ${{ needs.update_version.outputs.ios_from }}
      ios_to: ${{ inputs.ios_version }}
